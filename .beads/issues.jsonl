{"id":"mybd-71w","title":"Zero doctor warnings after bd init in clean room","description":"After running 'bd init' in a fresh git repo followed by committing the generated files, 'bd doctor' still reports 6 warnings. A project aiming to use beads should have ZERO doctor issues after initialization. This epic tracks each warning as a separate issue.","status":"open","priority":1,"issue_type":"epic","owner":"maphew@gmail.com","created_at":"2026-02-19T22:31:21Z","created_by":"maphew","updated_at":"2026-02-19T22:31:21Z","labels":["clean-room","doctor","init"]}
{"id":"mybd-71w.1","title":"Federation checks fail with 'database not found: beads' after clean bd init","description":"After 'bd init' in a clean repo, 3 federation checks all fail with 'Error 1049: database not found: beads':\n- Peer Connectivity: Unable to list remotes\n- Federation Conflicts: Unable to check conflicts  \n- Dolt Mode: Unable to list remotes\n\nThe database is named 'beads_mybd' (prefixed), but federation queries appear to look for a database named 'beads'. These checks should either: (a) query the correct database name, or (b) gracefully pass when no federation peers are configured (the 'Federation remotesapi' and 'Sync Staleness' checks already correctly return N/A).\n\nSeverity: WARNING (×3 warnings from single root cause)\nCategory: FEDERATION / BUG\nReproduce: mkdir t \u0026\u0026 cd t \u0026\u0026 git init \u0026\u0026 git commit --allow-empty -m init \u0026\u0026 bd init \u0026\u0026 git add -A \u0026\u0026 git commit -m 'bd init' \u0026\u0026 bd doctor","notes":"## Upstream References\n- No matching upstream issue found. The federation checks query a database named 'beads' (hardcoded?) instead of the actual database name 'beads_\u003cprefix\u003e'. This appears to be unreported upstream.\n- **PR #1556** (merged): 'fix: dolt_conflicts column, doctor gastown detection, explicit routing mode' — related federation/dolt work, but doesn't address the database name mismatch.","status":"closed","priority":1,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-19T22:31:33Z","created_by":"maphew","updated_at":"2026-02-20T00:14:14Z","closed_at":"2026-02-20T00:14:14Z","close_reason":"Fix merged in fix-71w-all branch (commit 1c1eba84). Clean room test: federation checks pass (64 passed, no federation warnings in bd doctor output).","labels":["bug","clean-room","doctor","federation"],"dependencies":[{"issue_id":"mybd-71w.1","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T15:31:33Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.2","title":"Dolt noms LOCK file warning after clean bd init","description":"After 'bd init' in a clean repo, doctor reports:\n  'noms LOCK file exists at dolt/beads_mybd/.dolt/noms/LOCK — may block database access'\n\nThe LOCK file is empty (0 bytes) and appears to be a leftover from the init process itself. No other dolt process is running. The suggested fix 'bd doctor --fix' does not remove it (says 'No automatic fix available').\n\nThis is likely a bug where bd init creates the LOCK file as part of dolt database initialization but doesn't clean it up. Doctor should either: (a) not flag an empty LOCK as dangerous, (b) bd init should clean up after itself, or (c) --fix should actually remove stale locks.\n\nSeverity: WARNING\nCategory: RUNTIME / BUG\nReproduce: mkdir t \u0026\u0026 cd t \u0026\u0026 git init \u0026\u0026 git commit --allow-empty -m init \u0026\u0026 bd init \u0026\u0026 bd doctor","notes":"## Upstream References\n- **PR #1802** (closed, not merged): 'fix: add dolt-access.lock and noms LOCK cleanup to bd doctor' — attempted to add LOCK cleanup with \u003e5min threshold. Was closed, not merged.\n- **PR #1850** (merged): 'fix(doctor): resolve bd doctor --fix hang by running fixes in-process' — added releaseDiagnosticLocks() to clean noms LOCK between diagnostic and fix phases. However this only cleans up LOCK files left by doctor itself, not by bd init.\n- **Issue #1861** (open): 'Bug: bd doctor --fix hangs on Dolt embedded mode (self-deadlock)' — related, describes the --fix hang.\n\nThe PR #1802 approach (stale LOCK cleanup with age threshold) was the right idea but was closed. The noms LOCK created by bd init is brand new (0 seconds old) so an age threshold won't help — the root fix should be in bd init itself cleaning up after database creation.","status":"in_progress","priority":2,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-19T22:31:42Z","created_by":"maphew","updated_at":"2026-02-20T00:14:21Z","labels":["bug","clean-room","doctor","dolt","lock"],"dependencies":[{"issue_id":"mybd-71w.2","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T15:31:41Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.2.1","title":"LOCK file recreated by bd sync --flush-only in pre-commit hook after fix-71w.2 cleanup","description":"During clean room test of fix-71w-all, the LOCK file is cleaned up by fix-71w.2 code in init.go AFTER store.Close(). However, the JJ pre-commit hook (installed because cleanroom is inside .jj parent dir) runs 'bd sync --flush-only' which reopens and closes the dolt DB, recreating the LOCK file. The LOCK file still shows as warning in bd doctor after init. Root cause: init cleans LOCK file, but pre-commit hook triggered by fix-71w.5's git commit call recreates it via bd sync. Either: (a) bd doctor LOCK check should ignore 0-byte LOCK files, or (b) bd init needs to clean LOCK file after the git commit step, or (c) bd sync --flush-only should clean LOCK file too.","status":"open","priority":2,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-20T00:14:36Z","created_by":"maphew","updated_at":"2026-02-20T00:14:36Z","dependencies":[{"issue_id":"mybd-71w.2.1","depends_on_id":"mybd-71w.2","type":"parent-child","created_at":"2026-02-19T17:14:36Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.3","title":"Git Upstream warning after clean bd init is expected but arguably shouldn't be a warning","description":"After 'bd init' in a clean repo, doctor reports:\n  'Git Upstream: No upstream configured for main'\n\nThis is technically correct — a freshly-initialized local repo has no remote. However, this is the expected state immediately after init. A user who just ran 'bd init' in a brand new project hasn't pushed anywhere yet.\n\nOptions:\n1. Don't warn if no git remote exists at all (no origin, no upstream) — this is clearly a new project\n2. Only warn if origin exists but upstream tracking is not set\n3. Downgrade to INFO level for repos with no remotes\n4. Have bd init suppress this by setting a 'freshly-initialized' flag\n\nSeverity: WARNING  \nCategory: GIT INTEGRATION / UX\nReproduce: mkdir t \u0026\u0026 cd t \u0026\u0026 git init \u0026\u0026 git commit --allow-empty -m init \u0026\u0026 bd init \u0026\u0026 git add -A \u0026\u0026 git commit -m 'bd init' \u0026\u0026 bd doctor","notes":"## Upstream References\n- **Issue #1095** (open): 'Feature: Allow suppressing specific bd doctor warnings' — generic suppression mechanism would allow users to silence this warning.\n- No specific upstream issue filed for git upstream false positive on repos with no remotes.","status":"closed","priority":3,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-19T22:31:51Z","created_by":"maphew","updated_at":"2026-02-20T00:14:14Z","closed_at":"2026-02-20T00:14:14Z","close_reason":"Fix merged in fix-71w-all branch (commit 434ded16). Clean room test: no git upstream warning in bd doctor output (doctor shows 64 passed).","labels":["clean-room","doctor","git","ux"],"dependencies":[{"issue_id":"mybd-71w.3","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T15:31:50Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.4","title":"Claude Plugin warning after clean bd init — not applicable to non-Claude users","description":"After 'bd init' in a clean repo, doctor reports:\n  'Claude Plugin: beads plugin not installed'\n\nThis warning appears regardless of whether the user uses Claude. For users of other AI coding tools (Amp, Cursor, Copilot, etc.) or no AI tool at all, this warning is irrelevant noise.\n\nOptions:\n1. Only show this warning if Claude is detected (e.g., claude CLI exists, or .claude/ directory exists)\n2. Move to a separate 'optional integrations' section that doesn't count as warnings\n3. Make integration checks configurable (opt-in)\n\nSeverity: WARNING\nCategory: INTEGRATIONS / UX\nReproduce: mkdir t \u0026\u0026 cd t \u0026\u0026 git init \u0026\u0026 git commit --allow-empty -m init \u0026\u0026 bd init \u0026\u0026 git add -A \u0026\u0026 git commit -m 'bd init' \u0026\u0026 bd doctor","notes":"## Upstream References\n- **Issue #1095** (open): 'Feature: Allow suppressing specific bd doctor warnings' — proposes doctor.suppress config namespace. Exactly the mechanism needed.\n- **Issue #1787** (open): 'bd doctor: false positive warnings for SQLite backend users' — same category of problem (irrelevant warnings for specific user configurations). Proposes either backend-aware check logic or suppression via #1095.\n\nBoth upstream issues are open with no PRs. The suppress-by-config approach (#1095) would generically solve this and mybd-71w.3 (git upstream).","status":"closed","priority":3,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-19T22:31:58Z","created_by":"maphew","updated_at":"2026-02-20T00:14:14Z","closed_at":"2026-02-20T00:14:14Z","close_reason":"Fix merged in fix-71w-all branch (commit 6a868c76). Clean room test: no Claude Plugin warning in bd doctor output (Claude CLI not present).","labels":["claude","clean-room","doctor","integrations","ux"],"dependencies":[{"issue_id":"mybd-71w.4","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T15:31:58Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.5","title":"bd init should leave zero doctor warnings without manual intervention","description":"After 'bd init' (before any manual git operations), doctor reports 10 warnings. Four resolve by committing the generated files. The remaining 6 persist even after committing.\n\nPre-commit warnings that bd init should prevent:\n1. Sync Divergence: Uncommitted .beads/ changes — bd init just created these files but doesn't commit them\n2. Dolt-JSONL Sync: Could not read JSONL file (beads.jsonl missing) — init creates issues.jsonl but doctor checks for beads.jsonl\n3. Git Working Tree: Uncommitted changes — bd init creates files but doesn't add/commit them  \n4. Git Hooks: Missing pre-push — bd init installs hooks but misses pre-push (fixed by --fix --yes)\n\nProposal: bd init should either auto-commit the generated .beads/ directory, or the doctor checks should recognize a freshly-initialized (uncommitted) state as acceptable. At minimum, bd init should install ALL hooks including pre-push.\n\nSeverity: WARNING (×4)\nCategory: INIT / UX  \nReproduce: mkdir t \u0026\u0026 cd t \u0026\u0026 git init \u0026\u0026 git commit --allow-empty -m init \u0026\u0026 bd init \u0026\u0026 bd doctor","notes":"## Upstream References\n- **Issue #409** (closed): 'bd init creates .beads/ with ref to issues.jsonl' — related to init file creation.\n- No specific upstream issue for bd init not committing generated files or missing pre-push hook during init.\n- **PR #1850** (merged): Added releaseDiagnosticLocks() — relevant to the Dolt-JSONL sync warning component.","status":"in_progress","priority":2,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-19T22:32:12Z","created_by":"maphew","updated_at":"2026-02-20T00:14:26Z","labels":["clean-room","doctor","init","ux"],"dependencies":[{"issue_id":"mybd-71w.5","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T15:32:11Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.5.1","title":"issues.jsonl created by pre-commit hook after git add in fix-71w.5, leaving it untracked","description":"During clean room test of fix-71w-all, the fix-71w.5 auto-commit correctly runs 'git add .beads/' and 'git commit'. However, the git commit triggers the pre-commit hook which runs 'bd sync --flush-only'. This creates .beads/issues.jsonl AFTER the git add step. Since the JJ pre-commit hook does NOT re-stage files (by design for jujutsu), issues.jsonl is not in the commit. Issues.jsonl then shows as untracked, causing Sync Divergence, Untracked Files, and Git Working Tree warnings in bd doctor. Root cause: the order of operations means issues.jsonl is always created by the first sync (in the pre-commit hook) after the git add. Fix: either (a) in the pre-commit hook, re-stage issues.jsonl before the commit finalizes, or (b) fix-71w.5 should run 'git add .beads/' a second time AFTER the commit to catch any files created by the hook, or (c) JJ hook detection should not walk parent dirs for cleanroom scenario.","status":"open","priority":2,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-20T00:14:47Z","created_by":"maphew","updated_at":"2026-02-20T00:14:47Z","dependencies":[{"issue_id":"mybd-71w.5.1","depends_on_id":"mybd-71w.5","type":"parent-child","created_at":"2026-02-19T17:14:47Z","created_by":"maphew","metadata":"{}"}]}
{"id":"mybd-71w.6","title":"IsJujutsuRepo() walks parent directories, causing wrong hooks in clean room test","description":"During clean room test: the cleanroom at ~/dev/mybd/scratch/cleanroom is inside ~/dev/mybd which has a .jj/ directory. GetJujutsuRoot() (internal/git/gitdir.go) walks UP parent directories looking for .jj/, finding the parent's .jj/. As a result, IsJujutsuRepo() returns true and JJ hooks are installed instead of regular git hooks. This causes: (1) pre-push hook is not installed (bd doctor warns about missing pre-push), (2) pre-commit hook in JJ mode does not re-stage files, causing issues.jsonl to not be committed. For clean room tests, the test directory should be outside any JJ parent, OR GetJujutsuRoot() should have an option to not traverse parent dirs, OR the test setup should use a truly isolated directory.","status":"open","priority":2,"issue_type":"task","owner":"maphew@gmail.com","created_at":"2026-02-20T00:15:02Z","created_by":"maphew","updated_at":"2026-02-20T00:15:02Z","dependencies":[{"issue_id":"mybd-71w.6","depends_on_id":"mybd-71w","type":"parent-child","created_at":"2026-02-19T17:15:02Z","created_by":"maphew","metadata":"{}"}]}
